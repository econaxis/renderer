<!doctype html>
<html lang="en">
<head>
    <title>renderer or something</title>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css2?family=Jura:wght@400;700&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
	<script src="index.js"></script>
	
</head>
<body onload="fetchObjs(); getLegend();">
	<! wide enough -- -->
	<div id="page">
		<div id="viewer">
			<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
		</div>
		
		<div id="control-panel" class="compact">
			<div id="info">
				<div class="info-block">
					<div class="large secondary">camera angle</div>
					<div class="large highlight">108°</div>
				</div>
				
				<div class="info-block">
					<div class="large secondary">field of view</div>
					<div class="large highlight">108°</div>
				</div>
				
				<div class="info-block">
					<div class="large secondary">camera position</div>
					<div class="large highlight">(0, 0, 400)</div>
				</div>
			</div>
			
			<hr class=" hidden">
			
			<div id="select" class="light-area hidden">
				<div class="dropdown-item" id="dropdown-item-main" onclick="showDropdown()">
					<div id="item-rendered"></div>
					<svg class="dropdown-icon" height="5" width="10">
						<polygon class="dropdown-icon" points="0,0 5,5 10,0"/>
					</svg>
				</div>
				<div class="dropdown-list light-area" id="obj-list">
				</div>
			</div>
			
			<div id="controls" class=" hidden">
				<! set initial values as needed -- -->
				<div class="control-label has-tooltip">reflectance</div> 
				<input type="range" 
					   min="1" max="100" value="50" 
					   class="control slider" 
					   id="reflectance-slider"
					   oninput="setReflectanceParameter()">
				
				<! toggles probably not responding because <input is size 0, 
					so i did it inline manually. will need to fix 
					confused because examples from the internet work-- -->
					   
				<div class="control-label has-tooltip">shadows</div>
				<div class="control"> 
					<label class="toggle">
						<input type="checkbox" id="shadow-toggle"/>
						<div class="toggle-button" onclick="toggleShadows()"></div>
					</label>
				</div>
				
				<div class="control-label has-tooltip">highlights</div>
				<div class="control"> 
					<label class="toggle">
						<input type="checkbox" checked id="highlights-toggle"/>
						<div class="toggle-button" onclick="toggleHighlights()"></div>
					</label>
				</div>
			</div>
			
			<div id="legend" class=" hidden">
			</div>
			
			<div id="bottom-controls">
				<div id="toggle-panel" class="lightarea closed" onclick="togglePanel()">
					<svg class="angle-icon" 
						 width="20" height="20" 
						 viewBox="0 0 20 20" 
						 fill="none" 
						 stroke-width="3" 
						 stroke-linecap="round" 
						 stroke-linejoin="round">
						<polyline points="2.5,8 10,15.5 17.5,8"/>
					</svg>
				</div>
			</div>
		</div>
		
		<div id="self-promo">
		
			<div id="toggle-fullscreen" class="ext-btn" onclick="toggleFS()">
				<svg class="fs-icon" 
					width="24" height="24" 
					viewBox="0 0 24 24" 
					fill="none" 
					stroke-width="1.5" 
					stroke-linecap="round" 
					stroke-linejoin="round">
					<polyline points=" 2, 8  2, 2  8, 2"/>
					<polyline points=" 2,16  2,22  8,22"/>
					<polyline points="22, 8 22, 2 16, 2"/>
					<polyline points="22,16 22,22 16,22"/>
				</svg>
				
				<svg class="fs-icon hidden" 
					width="24" height="24" 
					viewBox="0 0 24 24" 
					fill="none" 
					stroke-width="1.5" 
					stroke-linecap="round" 
					stroke-linejoin="round">
					<polyline points=" 2, 8  8, 8  8, 2"/>
					<polyline points=" 2,16  8,16  8,22"/>
					<polyline points="22, 8 16, 8 16, 2"/>
					<polyline points="22,16 16,16 16,22"/>
				</svg>
			</div>
			
			<div class="link" onclick="window.open('https://github.com/econaxis/renderer/')">Find us on github!</div>
		</div>
	</div>
	
	<! not wide enough -- -->
	<div id="mobile">
		<div>Oops!</div>
		<div class="description">We do not support too-skinny screens. Maybe try rotating your screen or making it wider.</div>
		<div class="link" onclick="window.open('https://github.com/econaxis/renderer/')">Find us on github! ❤</div>
		<div class="link" onclick="prettyPrettyPlease()">I don't wanna</div>
		<img class="hidden cat" src='please_cat.gif' alt="pretty pretty please" width=200/>
		<img class="hidden cat" src='please_cat.gif' alt="pretty pretty please" width=200/>
	</div>
	<script type="text/javascript">
		var statusElement = document.getElementById('status');
		var progressElement = document.getElementById('progress');
		var spinnerElement = document.getElementById('spinner');

		var Module = {
			preRun: [],
			postRun: [],
			print: (function () {
				var element = document.getElementById('output');
				if (element) element.value = ''; // clear browser cache
				return function (text) {
					if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
					// These replacements are necessary if you render to raw HTML
					//text = text.replace(/&/g, "&amp;");
					//text = text.replace(/</g, "&lt;");
					//text = text.replace(/>/g, "&gt;");
					//text = text.replace('\n', '<br>', 'g');
					console.log(text);
					if (element) {
						element.value += text + "\n";
						element.scrollTop = element.scrollHeight; // focus on bottom
					}
				};
			})(),
			printErr: function (text) {
				if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
				console.error(text);
			},
			canvas: (function () {
				var canvas = document.getElementById('canvas');

				// As a default initial behavior, pop up an alert when webgl context is lost. To make your
				// application robust, you may want to override this behavior before shipping!
				// See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
				canvas.addEventListener("webglcontextlost", function (e) {
					alert('WebGL context lost. You will need to reload the page.');
					e.preventDefault();
				}, false);

				return canvas;
			})(),
			setStatus: function (text) {
				if (!Module.setStatus.last) Module.setStatus.last = {time: Date.now(), text: ''};
				if (text === Module.setStatus.last.text) return;
				var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
				console.log("m is");
				console.log(m);
				var now = Date.now();
				if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
				Module.setStatus.last.time = now;
				Module.setStatus.last.text = text;
				if (m) {
					text = m[1];
					progressElement.value = parseInt(m[2]) * 100;
					progressElement.max = parseInt(m[4]) * 100;
					progressElement.hidden = false;
					spinnerElement.hidden = false;
				} else {
					progressElement.value = null;
					progressElement.max = null;
					progressElement.hidden = true;
					if (!text) spinnerElement.hidden = true;
				}
				statusElement.innerHTML = text;
			},
			totalDependencies: 0,
			monitorRunDependencies: function (left) {
				this.totalDependencies = Math.max(this.totalDependencies, left);
				Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
			}
		};
		Module.setStatus('Downloading...');
		window.onerror = function () {
			Module.setStatus('Exception thrown, see JavaScript console');
			spinnerElement.style.display = 'none';
			Module.setStatus = function (text) {
				if (text) Module.printErr('[post-exception status] ' + text);
			};
		};

		var addr = 0x2c84f90;
		var imagedata1 = null, u8, start = performance.now();

		function getaddr() {
			return Module.ccall('image_data_loc', 'number', [null], [null]);
		}

		function meas() {
			var ret = performance.now() - start;
			start = performance.now();
			console.debug(ret);
		}

		function render() {
			start = performance.now();
			Module._do_render();
			meas();
			addr = Module._image_data_loc();
			const t = Module.HEAPU8.slice(addr, addr + 3200000);
			meas();
			u8 = new Uint8ClampedArray(t);
			imagedata1 = new ImageData(u8, 1000, 800);
			meas();
			const ctx = document.getElementById('canvas').getContext('2d');
			ctx.putImageData(imagedata1, 0, 0);
			meas();
		}

		function render_light_view() {
			for (const i of intervals) clearInterval(i);

			Module._render_light_view();
			addr = Module._image_data_loc();
			const t = Module.HEAPU8.slice(addr, addr + 3200000);
			meas();
			u8 = new Uint8ClampedArray(t);
			imagedata1 = new ImageData(u8, 1000, 800);
			meas();
			const ctx = document.getElementById('canvas').getContext('2d');
			ctx.putImageData(imagedata1, 0, 0);
			meas();
		}
		var intervals = [];
		Module.onRuntimeInitialized = () => {
			intervals[0] = setInterval(() => {
				Module.ccall('input', 'null', [null], [null]);
			}, 30);
			intervals[1] = setInterval(() => {
				render();
			}, 120)
		}

		document.addEventListener('keydown', (e) => {
			if(e.key==="Q") {
				for (const i of intervals) clearInterval(i);
			}
		})
	</script>
	<script async="" type="text/javascript" src="game.js"></script>
	
</body>  
</html>
